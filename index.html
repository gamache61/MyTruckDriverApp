<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loadmaster Pro 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/DragControls.js"></script>

    <style>
        body { font-family: sans-serif; background-color: #111827; color: #f3f4f6; overscroll-behavior: none; padding-bottom: 50px; }
        .container { max-width: 1000px; margin: 0 auto; padding: 1rem; }
        
        #canvas-container {
            width: 100%; height: 35vh; 
            background: #000; border-radius: 12px; overflow: hidden;
            border: 2px solid #22c55e; position: relative; margin-bottom: 10px;
        }

        .overlay-controls {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.7); padding: 5px; border-radius: 8px; pointer-events: none;
        }
        .overlay-text { font-size: 10px; color: #aaa; }

        /* 2D Views */
        .viz-container { 
            background: #0f172a; padding: 10px; border-radius: 10px; 
            border: 1px solid #334155; margin-top: 10px; 
            overflow: auto; /* Allows scrolling */
        }
        
        /* IMPORTANT: touch-action: none prevents the browser from scrolling when dragging items */
        svg { background: #1e293b; border-radius: 4px; display: block; touch-action: none; }
        
        rect { stroke: #334155; stroke-width: 1; shape-rendering: crispEdges; cursor: grab; }
        rect:active { cursor: grabbing; }
        rect.selected { stroke: white; stroke-width: 2; fill-opacity: 1; }
        
        .delete-x-bg { fill: #ef4444; stroke: none; cursor: pointer; }
        .delete-x-text { fill: white; font-weight: bold; font-family: sans-serif; pointer-events: none; text-anchor: middle; dominant-baseline: middle; }

        text { fill: white; font-size: 10px; pointer-events: none; font-weight: bold; text-shadow: 0 1px 2px black; }
        .dim-text { fill: #22c55e; font-size: 12px; font-weight: bold; }

        /* UI */
        input, select { padding: 12px; margin: 5px 0; border: 1px solid #4b5563; border-radius: 6px; background: #374151; color: white; width: 100%; }
        button { padding: 12px 16px; border: none; border-radius: 6px; cursor: pointer; background: #10b981; color: white; margin-top:5px; font-weight: bold;}
        
        .tab-btn { flex: 1; background: #374151; color: #9ca3af; padding: 12px; border-radius: 8px; margin-right: 5px; font-size: 14px;}
        .tab-btn.active-tab { background: #22c55e; color: #ffffff; font-weight: bold; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .list-item { background: #1f2937; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 5px solid #34d399; display: flex; justify-content: space-between; align-items: center;}
        .delete-btn { background: #ef4444; color: white; border-radius: 4px; padding: 5px 15px; font-size: 12px; font-weight: bold; margin-left: 10px; cursor: pointer;}
        .hidden { display: none; }
        
        .zoom-controls { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; color: #aaa; font-size: 12px; }
        input[type=range] { width: 70%; margin: 0; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-xl font-bold text-green-500 text-center mb-4">Loadmaster Pro 3D</h1>

    <div class="flex overflow-x-auto mb-4">
        <button class="tab-btn active-tab" onclick="switchTab('main')">Plan</button>
        <button class="tab-btn" onclick="switchTab('customers')">Cust</button>
        <button class="tab-btn" onclick="switchTab('library')">Items</button>
        <button class="tab-btn" onclick="switchTab('trailers')">Trail</button>
        <button class="tab-btn" onclick="switchTab('settings')">Save</button>
    </div>

    <div id="main-tab" class="tab-content active">
        <div id="canvas-container">
            <div class="overlay-controls">
                <div class="overlay-text text-green-400 font-bold">3D is easiest for moving!</div>
                <div class="overlay-text">Drag boxes to move | 2 Fingers to Rotate</div>
            </div>
        </div>

        <div class="bg-gray-800 p-4 rounded-lg mt-2 border border-gray-700">
            <div class="flex gap-2">
                <select id="cust-select" class="flex-1"><option>Select Customer...</option></select>
                <select id="item-select" class="flex-1"><option>Select Item...</option></select>
            </div>
            <button class="w-full text-lg shadow-lg" onclick="addLoad()">+ LOAD ITEM</button>
        </div>
        
        <div class="mt-2 text-center text-xs text-gray-500" id="load-summary">0 items</div>

        <div class="viz-container mt-4">
            <div class="zoom-controls">
                <span>View Size:</span>
                <input type="range" id="zoom-slider" min="1" max="4" step="0.1" value="1" oninput="updateZoom(this.value)">
                <span id="zoom-val">100%</span>
            </div>

            <div class="mb-4">
                <div class="flex justify-between text-xs text-gray-400 uppercase font-bold mb-1">
                    <span>Nose</span><span>Top View</span><span>Door</span>
                </div>
                <div style="overflow-x: auto;">
                    <svg id="top-viz" height="100"></svg>
                </div>
            </div>
            <div>
                <div class="flex justify-between text-xs text-gray-400 uppercase font-bold mb-1">
                    <span>Height Check</span><span class="text-green-400">Side View (Stacking)</span>
                </div>
                <div style="overflow-x: auto;">
                    <svg id="side-viz" height="100"></svg>
                </div>
            </div>
        </div>
    </div>

    <div id="customers-tab" class="tab-content">
        <h2 class="text-lg mb-2 text-green-500 border-b border-gray-700">Customers</h2>
        <div class="flex gap-2"><input id="c-name" placeholder="Customer Name"><button onclick="saveCustomer()">Add</button></div>
        <div id="cust-list" class="mt-4"></div>
    </div>

    <div id="library-tab" class="tab-content">
        <h2 class="text-lg mb-2 text-green-500 border-b border-gray-700">Item Library</h2>
        <div class="bg-gray-800 p-3 rounded mb-4">
            <input id="lib-name" placeholder="Item Name">
            <div class="flex gap-2">
                <input type="number" id="lib-l" placeholder="Length (in)">
                <input type="number" id="lib-w" placeholder="Width (in)">
            </div>
            <div class="flex gap-2">
                <input type="number" id="lib-h" placeholder="Height (in)">
                <input type="number" id="lib-wt" placeholder="Weight (lbs)">
            </div>
            <input type="color" id="lib-color" value="#22c55e" class="h-10 w-full p-1 mt-2 rounded">
            <button class="w-full" onclick="saveLibItem()">Save Item</button>
        </div>
        <div id="library-list"></div>
    </div>

    <div id="trailers-tab" class="tab-content">
        <h2 class="text-lg mb-2 text-green-500 border-b border-gray-700">Trailers (Dimensions in Feet)</h2>
        <div class="bg-gray-800 p-3 rounded mb-4">
            <input id="t-name" placeholder="Trailer Name (e.g. Standard 53)">
            <div class="flex gap-2">
                <input type="number" id="t-l" placeholder="Length (Feet)">
                <input type="number" id="t-w" placeholder="Width (Feet)">
                <input type="number" id="t-h" placeholder="Height (Feet)">
            </div>
            <button class="w-full" onclick="saveTrailer()">Add Trailer</button>
        </div>
        <div id="trailer-list"></div>
    </div>

    <div id="settings-tab" class="tab-content">
        <h2 class="text-lg mb-2 text-green-500 border-b border-gray-700">Data Management</h2>
        <button class="bg-teal-600 w-full mb-4" onclick="exportData()">Export/Save File</button>
        <input type="file" id="file-input" class="hidden" onchange="importData(this)">
        <button class="bg-blue-600 w-full mb-8" onclick="document.getElementById('file-input').click()">Import/Load File</button>
        <button class="bg-red-600 w-full" onclick="hardReset()">FACTORY RESET APP</button>
    </div>
</div>

<script>
    // === APP STATE ===
    const KEY = "lm_final_v6";
    let app = {
        customers: [],
        library: [],
        trailers: [{id: 1, name: "Standard 53'", l: 636, w: 102, h: 110}], 
        activeTrailer: 1,
        load: []
    };
    let selectedUID = null;
    let currentZoom = 1.0;
    
    // 3D Globals
    let scene, camera, renderer, orbit, dragControls;
    let meshes = [], trailerMesh;
    const SCALAR = 0.05; 

    window.onload = function() {
        if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(r => r.forEach(i => i.unregister()));
        loadData();
        renderUI();
        init3D();
        render2D();
        setup2DDrag();
    };

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active-tab'));
        const btns = document.querySelectorAll('.tab-btn');
        if(id === 'main') btns[0].classList.add('active-tab');
        if(id === 'customers') btns[1].classList.add('active-tab');
        if(id === 'library') btns[2].classList.add('active-tab');
        if(id === 'trailers') btns[3].classList.add('active-tab');
        if(id === 'settings') btns[4].classList.add('active-tab');
        document.getElementById(id + '-tab').classList.add('active');
        if(id === 'main') trigger3DResize();
    }

    // --- DATA ACTIONS ---
    function addLoad() {
        const cId = document.getElementById('cust-select').value;
        const iId = document.getElementById('item-select').value;
        if(cId === "Select Customer..." || iId === "Select Item...") return alert("Select Customer & Item");
        const libItem = app.library.find(x => x.id == iId);
        const t = app.trailers.find(x => x.id === app.activeTrailer);
        let lastX = 0;
        app.load.forEach(i => { if(i.x + i.l > lastX) lastX = i.x + i.l; });
        const startX = (lastX + libItem.l <= t.l) ? lastX : 0;

        app.load.push({
            uid: Date.now(), name: libItem.name, l: libItem.l, w: libItem.w, h: libItem.h, wt: libItem.wt, color: libItem.color,
            x: startX, y: 0, z: 0, cId: cId
        });
        saveAndRender();
    }

    function deleteItem(uid) {
        if(confirm("Delete this item?")) {
            app.load = app.load.filter(i => i.uid !== uid);
            selectedUID = null;
            saveAndRender();
        }
    }
    
    function updateZoom(val) {
        currentZoom = parseFloat(val);
        document.getElementById('zoom-val').innerText = Math.round(currentZoom * 100) + "%";
        render2D();
    }

    // --- STORAGE ---
    function saveLibItem() {
        app.library.push({
            id: Date.now(), name: document.getElementById('lib-name').value || "Item",
            l: Number(document.getElementById('lib-l').value)||48, w: Number(document.getElementById('lib-w').value)||40, 
            h: Number(document.getElementById('lib-h').value)||48, wt: Number(document.getElementById('lib-wt').value)||1000,
            color: document.getElementById('lib-color').value
        });
        document.getElementById('lib-name').value = "";
        saveAndRender(); alert("Item Saved");
    }
    function saveCustomer() { app.customers.push({id: Date.now(), name: document.getElementById('c-name').value}); document.getElementById('c-name').value = ""; saveAndRender(); }
    function saveTrailer() {
        const l_ft = Number(document.getElementById('t-l').value);
        const w_ft = Number(document.getElementById('t-w').value);
        const h_ft = Number(document.getElementById('t-h').value);
        if(!l_ft || !w_ft || !h_ft) return alert("Please enter all dimensions in Feet");
        const id = Date.now();
        app.trailers.push({ id: id, name: document.getElementById('t-name').value || "Trailer", l: l_ft * 12, w: w_ft * 12, h: h_ft * 12 });
        app.activeTrailer = id; saveAndRender(); alert("Trailer Added");
    }

    function deleteLib(id) { if(confirm("Delete Item?")) { app.library = app.library.filter(x => x.id !== id); saveAndRender(); } }
    function deleteCust(id) { if(confirm("Delete Customer?")) { app.customers = app.customers.filter(x => x.id !== id); saveAndRender(); } }
    function deleteTrailer(id) { if(app.trailers.length > 1 && confirm("Delete Trailer?")) { app.trailers = app.trailers.filter(x => x.id !== id); saveAndRender(); } else { alert("Cannot delete last trailer."); }}
    function selectTrailer(id) { app.activeTrailer = id; saveAndRender(); }
    function saveAndRender() { saveData(); renderUI(); render2D(); buildLoad3D(); }
    function loadData() { const s = localStorage.getItem(KEY); if(s) app = JSON.parse(s); }
    function saveData() { localStorage.setItem(KEY, JSON.stringify(app)); }

    // --- RENDER UI ---
    function renderUI() {
        document.getElementById('library-list').innerHTML = app.library.map(i => `<div class="list-item" style="border-color:${i.color}"><div><b>${i.name}</b> <span class="text-xs text-gray-400">${i.l}x${i.w}x${i.h}</span></div><button class="delete-btn" onclick="deleteLib(${i.id}); event.stopPropagation();">DEL</button></div>`).join('');
        document.getElementById('cust-list').innerHTML = app.customers.map(c => `<div class="list-item"><span>${c.name}</span><button class="delete-btn" onclick="deleteCust(${c.id}); event.stopPropagation();">DEL</button></div>`).join('');
        document.getElementById('trailer-list').innerHTML = app.trailers.map(t => {
            const isActive = t.id === app.activeTrailer ? 'border-white bg-gray-700' : '';
            return `<div class="list-item ${isActive}" onclick="selectTrailer(${t.id})"><div class="flex-1 cursor-pointer"><b>${t.name}</b> <span class="text-xs text-gray-400">(${Math.round(t.l/12)}' x ${Math.round(t.w/12)}')</span></div><button class="delete-btn" onclick="deleteTrailer(${t.id}); event.stopPropagation();">DEL</button></div>`;
        }).join('');
        
        const cSelect = document.getElementById('cust-select');
        const iSelect = document.getElementById('item-select');
        const oldC = cSelect.value;
        const oldI = iSelect.value;
        
        cSelect.innerHTML = "<option>Select Customer...</option>" + app.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        iSelect.innerHTML = "<option>Select Item...</option>" + app.library.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
        
        if(oldC) cSelect.value = oldC;
        if(oldI) iSelect.value = oldI;

        document.getElementById('load-summary').innerText = `${app.load.length} items loaded`;
    }

    // --- 3D ENGINE ---
    function init3D() {
        const container = document.getElementById('canvas-container');
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111827);
        camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 30, 45); 
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        const amb = new THREE.AmbientLight(0xffffff, 0.6); scene.add(amb);
        const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(50,100,50); scene.add(dir);
        scene.add(new THREE.GridHelper(100, 100, 0x444444, 0x222222));

        orbit = new THREE.OrbitControls(camera, renderer.domElement);
        orbit.enableDamping = true;
        orbit.maxPolarAngle = Math.PI / 2; 

        buildTrailer3D();
        buildLoad3D();
        animate();
    }

    function buildTrailer3D() {
        if(trailerMesh) scene.remove(trailerMesh);
        const t = app.trailers.find(x => x.id === app.activeTrailer);
        const geo = new THREE.BoxGeometry(t.l * SCALAR, t.h * SCALAR, t.w * SCALAR);
        const edges = new THREE.EdgesGeometry(geo);
        trailerMesh = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x22c55e }));
        trailerMesh.position.y = (t.h * SCALAR) / 2;
        scene.add(trailerMesh);
    }

    function buildLoad3D() {
        meshes.forEach(m => scene.remove(m));
        meshes = [];
        if(dragControls) dragControls.dispose();

        const t = app.trailers.find(x => x.id === app.activeTrailer);

        app.load.forEach(item => {
            const geo = new THREE.BoxGeometry(item.l * SCALAR, item.h * SCALAR, item.w * SCALAR);
            const mat = new THREE.MeshLambertMaterial({ color: item.color });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(
                (item.x * SCALAR) - ((t.l * SCALAR)/2) + ((item.l * SCALAR)/2),
                (item.y * SCALAR) + ((item.h * SCALAR)/2),
                (item.z * SCALAR) - ((t.w * SCALAR)/2) + ((item.w * SCALAR)/2)
            );
            mesh.userData = { uid: item.uid };
            scene.add(mesh);
            meshes.push(mesh);
        });

        dragControls = new THREE.DragControls(meshes, camera, renderer.domElement);
        dragControls.addEventListener('dragstart', function (e) {
            orbit.enabled = false;
            e.object.material.emissive.set(0x555555);
            selectedUID = e.object.userData.uid;
            render2D();
        });
        dragControls.addEventListener('drag', function(e) {
            const mesh = e.object;
            const item = app.load.find(i => i.uid === mesh.userData.uid);
            const t = app.trailers.find(x => x.id === app.activeTrailer);
            const hL = (t.l * SCALAR)/2; const hW = (t.w * SCALAR)/2;
            if (mesh.position.x - (item.l*SCALAR)/2 < -hL) mesh.position.x = -hL + (item.l*SCALAR)/2;
            if (mesh.position.x + (item.l*SCALAR)/2 > hL) mesh.position.x = hL - (item.l*SCALAR)/2;
            if (mesh.position.z - (item.w*SCALAR)/2 < -hW) mesh.position.z = -hW + (item.w*SCALAR)/2;
            if (mesh.position.z + (item.w*SCALAR)/2 > hW) mesh.position.z = hW - (item.w*SCALAR)/2;
            if (mesh.position.y < (item.h*SCALAR)/2) mesh.position.y = (item.h*SCALAR)/2;
            
            // Sync Logic
            item.x = (mesh.position.x + (t.l * SCALAR)/2 - (item.l * SCALAR)/2) / SCALAR;
            item.y = (mesh.position.y - (item.h * SCALAR)/2) / SCALAR;
            item.z = (mesh.position.z + (t.w * SCALAR)/2 - (item.w * SCALAR)/2) / SCALAR;
            render2D();
        });
        dragControls.addEventListener('dragend', function (e) {
            orbit.enabled = true;
            e.object.material.emissive.set(0x000000);
            saveData();
        });
    }

    function animate() { requestAnimationFrame(animate); orbit.update(); renderer.render(scene, camera); }
    function trigger3DResize() {
        const c = document.getElementById('canvas-container');
        camera.aspect = c.clientWidth / c.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(c.clientWidth, c.clientHeight);
    }

    // --- 2D ENGINE (RED X BUTTONS) ---
    function render2D() {
        const t = app.trailers.find(x => x.id === app.activeTrailer);
        const top = document.getElementById('top-viz');
        const side = document.getElementById('side-viz');
        
        // Use Zoom
        const sc = getScale();

        top.setAttribute("width", t.l * sc);
        top.setAttribute("height", t.w * sc + 20); 
        side.setAttribute("width", t.l * sc);
        side.setAttribute("height", t.h * sc + 20);

        let topH = `<rect x="0" y="0" width="${t.l*sc}" height="${t.w*sc}" fill="#111827" stroke="cyan" stroke-width="2"/>`;
        topH += `<text x="${(t.l*sc)/2}" y="${t.w*sc + 15}" text-anchor="middle" class="dim-text">${Math.round(t.l/12)}' L</text>`;
        
        let sideH = `<rect x="0" y="0" width="${t.l*sc}" height="${t.h*sc}" fill="#111827" stroke="cyan" stroke-width="2"/>`;
        sideH += `<text x="${t.l*sc - 5}" y="${(t.h*sc)/2}" text-anchor="end" dominant-baseline="middle" class="dim-text" transform="rotate(-90, ${t.l*sc-5}, ${(t.h*sc)/2})">${Math.round(t.h/12)}' H</text>`;

        app.load.forEach(p => {
            const isSel = selectedUID === p.uid;
            const cls = isSel ? 'selected' : '';
            const itemW = p.l * sc;
            const itemH = p.w * sc; 
            const btnSz = 20; 
            
            // TOP VIEW
            const delX = (p.x * sc) + (p.l * sc) - btnSz;
            const delY = (p.z * sc); 
            topH += `
                <g class="item-group">
                    <rect data-uid="${p.uid}" data-view="top" x="${p.x*sc}" y="${p.z*sc}" width="${p.l*sc}" height="${p.w*sc}" fill="${p.color}" class="${cls}" opacity="0.8"/>
                    <text x="${(p.x*sc)+(p.l*sc)/2}" y="${(p.z*sc)+(p.w*sc)/2}" text-anchor="middle" dominant-baseline="middle" font-size="${10*currentZoom}">${p.name.substring(0,3)}</text>
                    <g onclick="deleteItem(${p.uid}); event.stopPropagation();">
                        <rect x="${Math.max(p.x*sc, delX)}" y="${delY}" width="${btnSz}" height="${btnSz}" class="delete-x-bg" rx="4"/>
                        <text x="${Math.max(p.x*sc, delX) + btnSz/2}" y="${delY + btnSz/2 + 1}" class="delete-x-text" font-size="14">×</text>
                    </g>
                </g>
            `;
            
            // SIDE VIEW
            const sideY = (t.h - p.y - p.h) * sc;
            const delSideX = (p.x * sc) + (p.l * sc) - btnSz;
            sideH += `
                <g class="item-group">
                    <rect data-uid="${p.uid}" data-view="side" x="${p.x*sc}" y="${sideY}" width="${p.l*sc}" height="${p.h*sc}" fill="${p.color}" class="${cls}" opacity="0.8"/>
                    <g onclick="deleteItem(${p.uid}); event.stopPropagation();">
                        <rect x="${Math.max(p.x*sc, delSideX)}" y="${sideY}" width="${btnSz}" height="${btnSz}" class="delete-x-bg" rx="4"/>
                        <text x="${Math.max(p.x*sc, delSideX) + btnSz/2}" y="${sideY + btnSz/2 + 1}" class="delete-x-text" font-size="14">×</text>
                    </g>
                </g>
            `;
        });
        top.innerHTML = topH; 
        side.innerHTML = sideH;
    }
    
    function getScale() {
        const t = app.trailers.find(x => x.id === app.activeTrailer);
        const top = document.getElementById('top-viz');
        const baseWidth = top.parentElement.clientWidth || 300; 
        return (baseWidth / t.l) * currentZoom;
    }

    // --- 2D DRAGGING (UPDATED) ---
    function setup2DDrag() {
        let dragTarget = null;
        let offset = {x:0, y:0}; // Offset from item corner
        let currentView = ''; 

        const handleStart = (e) => {
            const target = e.target.closest('rect[data-uid]');
            if(!target) return;
            e.preventDefault(); // Stop Scroll
            
            const uid = target.dataset.uid;
            dragTarget = app.load.find(i => i.uid == uid);
            selectedUID = uid;
            currentView = target.dataset.view;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            // Calculate Offset inside the box
            const svg = currentView === 'top' ? document.getElementById('top-viz') : document.getElementById('side-viz');
            const rect = svg.getBoundingClientRect();
            const sc = getScale();
            const mouseX = (clientX - rect.left) / sc;
            const mouseY = (clientY - rect.top) / sc;
            
            if(currentView === 'top') {
                offset.x = mouseX - dragTarget.x;
                offset.y = mouseY - dragTarget.z; // Z is Y on screen
            } else {
                offset.x = mouseX - dragTarget.x;
                // Side view Y is inverted math
